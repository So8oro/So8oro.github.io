---
title: 모의투자 서비스에서 실시간 주식 데이터 병목을 어떻게 해결했는가
date: 2025-09-08 09:00:00 +0900
categories: [Backend, Project]
tags: [모의투자, 실시간, 주식데이터, 병목해결]
---

## 프로젝트 배경

이번에 진행 중인 프로젝트는 **모의투자 서비스**입니다.  
증권사 API를 직접 사용해 데이터를 받아오지만, **요청 제한**이 있어 모든 기능을 API에 의존할 수는 없습니다.  
따라서 주식 관련 정보(종목명, 시가/고가/저가, 전일 대비 등)는 API를 통해 가져오되,  
**체결 엔진은 내부적으로 구현**하기로 결정했습니다.

---

## 문제 상황

서비스의 메인 페이지에서는 **200개 종목을 거래량 기준으로 정렬하여 10초 단위로 업데이트**해야 합니다.  

문제는 다음과 같았습니다.

- 다수의 사용자가 동시에 조회하는 경우,  
- 백엔드에서 200개 종목 정렬 연산이 수행 중이면  
- 응답이 지연되거나 병목 현상이 발생할 수 있음

즉, **실시간 업데이트와 사용자 조회가 충돌**하는 구조였습니다.

---

## 해결 아이디어

![그림1](/assets/img/20250908_조회방법.png)

그림과 같이, **배열 3개를 사용하는 구조**를 적용했습니다.

1. **실시간 업데이트 배열 (배열 1)**  
   - 증권사 API를 통해 들어오는 종목별 최신 정보를 저장
2. **조회용 배열 OLD**
   - 사용자가 조회할 때 읽는 배열
3. **조회용 배열 NEW**
   - 10초 단위(변동 가능)로 정렬한 결과를 임시로 담는 배열

작동 방식은 다음과 같습니다.

- 실시간 데이터는 항상 **1번 배열**에 기록  
- 사용자는 **OLD 배열**에서 안정적으로 조회  
- 10초마다 1번 배열의 데이터를 정렬하여 **NEW 배열**로 이동  
- 정렬이 끝나면 **OLD와 NEW를 교체**  
- 이렇게 하면 정렬 중에도 사용자는 끊김 없이 OLD에서 데이터를 볼 수 있음

---

## 간단한 의사코드

```python
# 실시간 업데이트: 1번 배열에 기록
def update_realtime_data(stock):
    realtime_array[stock.code] = stock

# 10초 단위로 정렬
def refresh_sorted_data():
    new_array = sort_by_volume(realtime_array)
    replace_old_with_new(new_array)

# 사용자 조회
def get_sorted_data():
    return old_array
```
## 결과와 배운 점

- 정렬 연산이 수행되는 동안에도 사용자는 항상 안정적인 OLD 배열에서 데이터를 확인할 수 있었습니다.
- 병목 구간이 줄어들고, 조회 지연 없이 실시간성을 제공할 수 있었습니다.
- 실시간 서비스에서는 연산과 조회를 분리하고, 데이터 교체 시점을 명확히 관리하는 것이 중요하다는 교훈을 얻었습니다.

## 더 공부할 내용

- **Redis와 캐싱 기본 이해**  
  - [Redis란](https://namji9507.tistory.com/entry/Database-Redis-%EB%A0%88%EB%94%94%EC%8A%A4Redis%EB%9E%80)  
    Redis의 정의, 구조, 장단점 및 캐싱이나 실시간 분석에의 활용 사례가 잘 정리되어 있습니다.  

- **실시간 분석에서 Redis 활용**  
  - [Redis 사용 사례 (Velog)](https://velog.io/%40qkrtkdwns3410/REDIS-%EC%82%AC%EC%9A%A9-%EC%82%AC%EB%A1%80)  
    실시간 데이터 처리, 메시지 브로커, 레이트 리미팅 등 Redis의 다양한 활용 사례를 소개합니다.  

- **분산 시스템에서의 캐시 전략**  
  - [분산 시스템에서 로컬 캐시 활용하기 (카카오페이 기술블로그)](https://tech.kakaopay.com/post/local-caching-in-distributed-systems/)  
    글로벌 캐시와 로컬 캐시의 차이, 캐시 정합성 고민, 메시징 시스템 사용 방안 등을 현실적인 사례로 설명합니다.  

- **캐싱 개념 및 시스템 설계 이해**  
  - [캐싱 - Bldev's Blog](https://bldev2473.github.io/architecture-software/caching)  
    로컬 캐시, 글로벌 캐시, 분산 캐시 및 캐시 스탬피드(cache stampede) 같은 이슈를 조망하는 글입니다.  
